<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagos - TransportePro</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
.header .logo { font-size: 1.5rem; font-weight: bold; }
.btn-logout { background: rgba(255,255,255,0.2); border: 1px solid white; padding: 0.5rem 1rem; border-radius: 5px; color: white; cursor: pointer; }
.btn-logout:hover { background: rgba(255,255,255,0.3); }
.container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
h2 { color: #333; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
.tabs { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
.tab { padding: 0.5rem 1rem; cursor: pointer; border-radius: 5px; background: #ddd; transition: 0.3s; }
.tab.active { background: #667eea; color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 0.5rem; text-align: left; }
.btn { padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
.btn:hover { background: #5568d3; }
.btn-delete { background: #e74c3c; }
.btn-delete:hover { background: #c0392b; }
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
.modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px; }
.close-modal { float: right; cursor: pointer; font-size: 1.5rem; }
form { display: flex; flex-direction: column; gap: 1rem; }
input, select { padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
</style>
</head>
<body>

<div class="header">
    <div class="logo">ðŸ’³ Pagos - TransportePro</div>
    <button class="btn-logout" onclick="logout()">Cerrar SesiÃ³n</button>
</div>

<div class="container">
<h2>GestiÃ³n de Pagos y Reservas</h2>

<div class="tabs">
    <div class="tab active" data-tab="pagos">Pagos</div>
    <div class="tab" data-tab="reservas">Reservas</div>
</div>

<div class="tab-content active" id="pagos">
    <table>
        <thead>
            <tr><th>ID</th><th>Cliente</th><th>Monto</th><th>MÃ©todo</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr>
        </thead>
        <tbody id="pagosTable"></tbody>
    </table>
</div>

<div class="tab-content" id="reservas">
    <table>
        <thead>
            <tr><th>ID</th><th>Cliente</th><th>Viaje</th><th>Estado</th><th>Fecha Reserva</th><th>Acciones</th></tr>
        </thead>
        <tbody id="reservasTable"></tbody>
    </table>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle"></h3>
    <form id="modalForm" onsubmit="saveEntity(event)"></form>
</div>
</div>

<script>
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');
let currentEntity = '';
let editingItem = null;

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        contents.forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

function logout() {
    localStorage.removeItem('usuario');
    localStorage.removeItem('token');
    window.location.href='/login';
}

function openModal(entity, item=null){
    currentEntity = entity;
    editingItem = item;
    document.getElementById('modal').style.display='flex';
    const form = document.getElementById('modalForm');
    const title = document.getElementById('modalTitle');
    form.innerHTML='';
    if(entity==='pagos'){
        title.textContent = item?'Editar Pago':'Agregar Pago';
        form.innerHTML = `
            <input type="number" name="id_cliente" placeholder="ID Cliente" value="${item?.id_cliente||''}" required>
            <input type="number" name="monto" placeholder="Monto" value="${item?.monto||''}" required>
            <select name="metodo" required>
                <option value="">MÃ©todo</option>
                <option value="tarjeta" ${item?.metodo==='tarjeta'?'selected':''}>Tarjeta</option>
                <option value="nequi" ${item?.metodo==='nequi'?'selected':''}>Nequi</option>
                <option value="daviplata" ${item?.metodo==='daviplata'?'selected':''}>Daviplata</option>
                <option value="efectivo" ${item?.metodo==='efectivo'?'selected':''}>Efectivo</option>
            </select>
            <select name="estado" required>
                <option value="pendiente" ${item?.estado==='pendiente'?'selected':''}>Pendiente</option>
                <option value="validado" ${item?.estado==='validado'?'selected':''}>Validado</option>
                <option value="rechazado" ${item?.estado==='rechazado'?'selected':''}>Rechazado</option>
            </select>
            <button class="btn" type="submit">Guardar</button>
        `;
    } else if(entity==='reservas'){
        title.textContent = item?'Editar Reserva':'Agregar Reserva';
        form.innerHTML = `
            <input type="number" name="id_cliente" placeholder="ID Cliente" value="${item?.id_cliente||''}" required>
            <input type="number" name="id_viaje" placeholder="ID Viaje" value="${item?.id_viaje||''}" required>
            <select name="estado" required>
                <option value="pendiente" ${item?.estado==='pendiente'?'selected':''}>Pendiente</option>
                <option value="confirmada" ${item?.estado==='confirmada'?'selected':''}>Confirmada</option>
                <option value="cancelada" ${item?.estado==='cancelada'?'selected':''}>Cancelada</option>
            </select>
            <button class="btn" type="submit">Guardar</button>
        `;
    }
}

function closeModal(){ document.getElementById('modal').style.display='none'; }

async function saveEntity(event){
    event.preventDefault();
    const formData = Object.fromEntries(new FormData(event.target).entries());
    let url = `/api/${currentEntity}`;
    let method = editingItem?'PUT':'POST';
    if(editingItem) url += `/${editingItem.id}`;

    await fetch(url,{
        method,
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(formData)
    });
    closeModal();
    await loadTables();
}

async function deleteRow(entity,id){
    if(confirm('Â¿Seguro de eliminar este registro?')){
        await fetch(`/api/${entity}/${id}`,{method:'DELETE'});
        await loadTables();
    }
}

async function loadTables(){
    // Pagos
    const pagos = await fetch('/api/pagos').then(r=>r.json());
    document.getElementById('pagosTable').innerHTML = pagos.map(p=>`
        <tr>
            <td>${p.id}</td>
            <td>${p.nombre_cliente}</td>
            <td>${p.monto}</td>
            <td>${p.metodo}</td>
            <td>${p.estado}</td>
            <td>${p.fecha}</td>
            <td>
                <button class="btn" onclick='openModal("pagos", ${JSON.stringify(p)})'>Editar</button>
                <button class="btn-delete" onclick="deleteRow('pagos',${p.id})">Eliminar</button>
            </td>
        </tr>
    `).join('');

    // Reservas
    const reservas = await fetch('/api/reservas').then(r=>r.json());
    document.getElementById('reservasTable').innerHTML = reservas.map(r=>`
        <tr>
            <td>${r.id}</td>
            <td>${r.nombre_cliente}</td>
            <td>${r.id_viaje}</td>
            <td>${r.estado}</td>
            <td>${r.fecha_reserva}</td>
            <td>
                <button class="btn" onclick='openModal("reservas", ${JSON.stringify(r)})'>Editar</button>
                <button class="btn-delete" onclick="deleteRow('reservas',${r.id})">Eliminar</button>
            </td>
        </tr>
    `).join('');
}

loadTables();
</script>
</body>
</html>