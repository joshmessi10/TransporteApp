<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Organizaci√≥n - TransportePro</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
.header .logo { font-size: 1.5rem; font-weight: bold; }
.btn-logout { background: rgba(255,255,255,0.2); border: 1px solid white; padding: 0.5rem 1rem; border-radius: 5px; color: white; cursor: pointer; }
.btn-logout:hover { background: rgba(255,255,255,0.3); }
.container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
h2 { color: #333; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
.tabs { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
.tab { padding: 0.5rem 1rem; cursor: pointer; border-radius: 5px; background: #ddd; transition: 0.3s; }
.tab.active { background: #667eea; color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 0.5rem; text-align: left; }
.btn { padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
.btn:hover { background: #5568d3; }
.btn-delete { background: #e74c3c; }
.btn-delete:hover { background: #c0392b; }
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
.modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px; }
.close-modal { float: right; cursor: pointer; font-size: 1.5rem; }
form { display: flex; flex-direction: column; gap: 1rem; }
input, select { padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
</style>
</head>
<body>
<div class="header">
    <div class="logo">üè¢ Organizaci√≥n - TransportePro</div>
    <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
</div>

<div class="container">
<h2>Gesti√≥n Organizacional</h2>
<div class="tabs">
    <div class="tab active" data-tab="vehiculos">Veh√≠culos</div>
    <div class="tab" data-tab="sedes">Sedes</div>
    <div class="tab" data-tab="conductores">Conductores</div>
    <div class="tab" data-tab="mantenimientos">Mantenimientos</div>
</div>

<div class="tab-content active" id="vehiculos">
    <button class="btn" onclick="openModal('vehiculo')">Agregar Veh√≠culo</button>
    <table>
        <thead>
            <tr><th>ID</th><th>Placa</th><th>Marca</th><th>Modelo</th><th>Acciones</th></tr>
        </thead>
        <tbody id="vehiculosTable"></tbody>
    </table>
</div>

<div class="tab-content" id="sedes">
    <button class="btn" onclick="openModal('sede')">Agregar Sede</button>
    <table>
        <thead>
            <tr><th>ID</th><th>Nombre</th><th>Direcci√≥n</th><th>Acciones</th></tr>
        </thead>
        <tbody id="sedesTable"></tbody>
    </table>
</div>

<div class="tab-content" id="conductores">
    <button class="btn" onclick="openModal('conductor')">Agregar Conductor</button>
    <table>
        <thead>
            <tr><th>ID</th><th>Nombre</th><th>Licencia</th><th>Acciones</th></tr>
        </thead>
        <tbody id="conductoresTable"></tbody>
    </table>
</div>

<div class="tab-content" id="mantenimientos">
    <button class="btn" onclick="openModal('mantenimiento')">Agregar Mantenimiento</button>
    <table>
        <thead>
            <tr><th>ID</th><th>ID Veh√≠culo</th><th>Fecha</th><th>Detalle</th><th>Acciones</th></tr>
        </thead>
        <tbody id="mantenimientosTable"></tbody>
    </table>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle"></h3>
    <form id="modalForm" onsubmit="saveEntity(event)"></form>
</div>
</div>

<script>
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');
let currentEntity = '';
let editingItem = null;

// Cambiar pesta√±as
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    contents.forEach(c => c.classList.remove('active'));
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

function logout() {
  if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
    localStorage.removeItem('usuario');
    localStorage.removeItem('token');
    window.location.href = '/login';
  }
}

// Mapea la entidad del modal a la ruta real de la API
const ENTITY_API = {
  vehiculo: 'vehiculos',
  sede: 'sedes',
  conductor: 'conductores',
  mantenimiento: 'mantenimientos'
};

function openModal(entity, item = null) {
  currentEntity = entity;
  editingItem = item;
  document.getElementById('modal').style.display = 'flex';
  const form = document.getElementById('modalForm');
  const title = document.getElementById('modalTitle');
  form.innerHTML = '';

  if (entity === 'vehiculo') {
    title.textContent = item ? 'Editar Veh√≠culo' : 'Agregar Veh√≠culo';
    form.innerHTML = `
      <input type="text" name="placa" placeholder="Placa" value="${item?.placa || ''}" required>
      <select name="tipo" required>
        <option value="">Tipo de veh√≠culo</option>
        <option value="bus" ${item?.tipo === 'bus' ? 'selected' : ''}>Bus</option>
        <option value="camioneta" ${item?.tipo === 'camioneta' ? 'selected' : ''}>Camioneta</option>
        <option value="camion" ${item?.tipo === 'camion' ? 'selected' : ''}>Cami√≥n</option>
      </select>
      <input type="number" name="capacidad" placeholder="Capacidad (pasajeros / kg)" value="${item?.capacidad || ''}">
      <input type="number" name="kilometraje" placeholder="Kilometraje" value="${item?.kilometraje || ''}">
      <select name="estado">
        <option value="activo" ${item?.estado === 'activo' ? 'selected' : ''}>Activo</option>
        <option value="mantenimiento" ${item?.estado === 'mantenimiento' ? 'selected' : ''}>En mantenimiento</option>
        <option value="inactivo" ${item?.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
      </select>
      <input type="number" name="id_sede" placeholder="ID Sede" value="${item?.id_sede || ''}">
      <button class="btn" type="submit">Guardar</button>
    `;
  } else if (entity === 'sede') {
    title.textContent = item ? 'Editar Sede' : 'Agregar Sede';
    form.innerHTML = `
      <input type="text" name="nombre" placeholder="Nombre Sede" value="${item?.nombre || ''}" required>
      <input type="text" name="direccion" placeholder="Direcci√≥n" value="${item?.direccion || ''}" required>
      <input type="text" name="ciudad" placeholder="Ciudad" value="${item?.ciudad || ''}">
      <input type="text" name="telefono" placeholder="Tel√©fono" value="${item?.telefono || ''}">
      <button class="btn" type="submit">Guardar</button>
    `;
  } else if (entity === 'conductor') {
    title.textContent = item ? 'Editar Conductor' : 'Agregar Conductor';
    form.innerHTML = `
      <input type="text" name="nombre" placeholder="Nombre" value="${item?.nombre || ''}" required>
      <input type="text" name="licencia" placeholder="N√∫mero de Licencia" value="${item?.licencia || ''}" required>
      <input type="text" name="categoria" placeholder="Categor√≠a (ej. C1, C2)" value="${item?.categoria || ''}">
      <input type="number" name="id_sede" placeholder="ID Sede" value="${item?.id_sede || ''}">
      <button class="btn" type="submit">Guardar</button>
    `;
  } else if (entity === 'mantenimiento') {
    // Se alinea con MantenimientoController.programar
    title.textContent = item ? 'Editar Mantenimiento' : 'Programar Mantenimiento';
    form.innerHTML = `
      <input type="text" name="vehiculoPlaca" placeholder="Placa del veh√≠culo" value="${item?.placa || ''}" required>
      <input type="text" name="tipo" placeholder="Tipo de mantenimiento" value="${item?.tipo || ''}">
      <input type="date" name="fecha_programado" value="${item?.fecha_programado || ''}" required>
      <button class="btn" type="submit">Guardar</button>
    `;
  }
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

async function saveEntity(event) {
  event.preventDefault();
  const rawData = Object.fromEntries(new FormData(event.target).entries());

  const apiSegment = ENTITY_API[currentEntity];
  if (!apiSegment) return;

  let url = `/api/${apiSegment}`;
  let method = editingItem ? 'PUT' : 'POST';

  // Construir payload seg√∫n entidad
  let payload = { ...rawData };

  if (currentEntity === 'mantenimiento') {
    // El backend espera: vehiculoPlaca, tipo, fecha_programado
    payload = {
      vehiculoPlaca: rawData.vehiculoPlaca,
      tipo: rawData.tipo || null,
      fecha_programado: rawData.fecha_programado || null
    };
    // No hay endpoint gen√©rico PUT /api/mantenimientos/:id, solo iniciar/finalizar.
    // Para "editar", por ahora tratamos siempre como crear nuevo.
    method = 'POST';
  }

  // Para las dem√°s entidades s√≠ soportamos editar
  if (editingItem && currentEntity !== 'mantenimiento') {
    url += `/${editingItem.id}`;
  }

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  closeModal();
  await loadTables();
}

async function deleteRow(entity, id) {
  if (confirm('¬øSeguro de eliminar este registro?')) {
    await fetch(`/api/${entity}/${id}`, { method: 'DELETE' });
    await loadTables();
  }
}

async function loadTables() {
  // Veh√≠culos
  const respV = await fetch('/api/vehiculos');
  const dataV = await respV.json();
  const vehiculos = Array.isArray(dataV) ? dataV : (dataV.vehiculos || []);

  document.getElementById('vehiculosTable').innerHTML = vehiculos.map(v => `
    <tr>
      <td>${v.id}</td>
      <td>${v.placa}</td>
      <td>${v.tipo || '-'}</td>
      <td>${v.capacidad ?? ''}</td>
      <td>
        <button class="btn" onclick='openModal("vehiculo", ${JSON.stringify(v)})'>Editar</button>
        <button class="btn-delete" onclick="deleteRow('vehiculos',${v.id})">Eliminar</button>
      </td>
    </tr>
  `).join('');

  // Sedes
  const respS = await fetch('/api/sedes');
  const dataS = await respS.json();
  const sedes = Array.isArray(dataS) ? dataS : (dataS.sedes || []);

  document.getElementById('sedesTable').innerHTML = sedes.map(s => `
    <tr>
      <td>${s.id}</td>
      <td>${s.nombre}</td>
      <td>${s.direccion}</td>
      <td>
        <button class="btn" onclick='openModal("sede", ${JSON.stringify(s)})'>Editar</button>
        <button class="btn-delete" onclick="deleteRow('sedes',${s.id})">Eliminar</button>
      </td>
    </tr>
  `).join('');

  // Conductores
  const respC = await fetch('/api/conductores');
  const dataC = await respC.json();
  const conductores = Array.isArray(dataC) ? dataC : (dataC.conductores || []);

  document.getElementById('conductoresTable').innerHTML = conductores.map(c => `
    <tr>
      <td>${c.id}</td>
      <td>${c.nombre}</td>
      <td>${c.licencia}</td>
      <td>
        <button class="btn" onclick='openModal("conductor", ${JSON.stringify(c)})'>Editar</button>
        <button class="btn-delete" onclick="deleteRow('conductores',${c.id})">Eliminar</button>
      </td>
    </tr>
  `).join('');

  // Mantenimientos
  const respM = await fetch('/api/mantenimientos');
  const dataM = await respM.json();
  const mantenimientos = Array.isArray(dataM) ? dataM : (dataM.mantenimientos || []);

  document.getElementById('mantenimientosTable').innerHTML = mantenimientos.map(m => `
    <tr>
      <td>${m.id}</td>
      <td>${m.id_vehiculo || ''}</td>
      <td>${m.fecha_programado || ''}</td>
      <td>${m.tipo || ''}</td>
      <td>
        <button class="btn" onclick='openModal("mantenimiento", ${JSON.stringify(m)})'>Editar</button>
        <button class="btn-delete" onclick="deleteRow('mantenimientos',${m.id})">Eliminar</button>
      </td>
    </tr>
  `).join('');
}

loadTables();
</script>

</body>
</html>